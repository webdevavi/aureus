<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>{{ report_meta.company_name }} Report</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              fira: ["Fira Sans", "sans-serif"],
            },
          },
        },
      };
    </script>
    <link
      href="https://fonts.googleapis.com/css2?family=Fira+Sans:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      html,
      body {
        max-width: 100%;
        overflow-x: hidden;
        box-sizing: border-box;
      }
      body {
        margin: 0;
        padding: 0.5rem 1rem;
        font-family: "Fira Sans", sans-serif;
      }
      table {
        width: 100%;
        table-layout: auto;
        border-collapse: collapse;
      }
      th,
      td {
        word-wrap: break-word;
        white-space: normal;
        overflow-wrap: anywhere;
        padding: 4px 6px;
      }
      th {
        font-weight: 600;
      }
      .table-wrapper {
        overflow-x: auto;
        max-width: 100%;
      }
      .charts-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 1rem;
        width: 100%;
      }
      .chart-box {
        border: 1px solid #e5e7eb;
        border-radius: 10px;
        background: #ffffff;
        padding: 1rem;
      }
      canvas {
        width: 100% !important;
        height: 200px !important;
        display: block;
      }
      main {
        display: grid;
        grid-template-columns: 42% 58%;
        width: 100%;
      }
      header {
        margin-bottom: 0.75rem;
      }
      @media print {
        html,
        body {
          margin: 0;
          padding: 0;
          overflow: hidden;
        }
        header {
          page-break-after: avoid !important;
        }
        th,
        td {
          padding: 3px 5px;
          font-size: 9.5px;
        }
      }
      h1,
      h2,
      h3,
      h4 {
        color: #4b5563;
        margin: 0;
      }
      hr {
        border: none;
        border-top: 2px solid #a78bfa;
        margin: 0.25rem 0 0.5rem 0;
      }
    </style>
  </head>

  <body class="p-2 m-0 box-border flex flex-col gap-4 font-fira">
    {% macro safe_val(v, suffix='') -%} {%- if v is none or v == '' or
    v|string|lower in ['null', 'none'] -%} - {%- else -%} {{ v|string + suffix
    }} {%- endif -%} {%- endmacro %} {% macro safe_num(v, default=0.0) -%} {{
    default if v is none else v }} {%- endmacro %} {% macro safe_sum(values) -%}
    {%- if values is sequence and values is not string -%} {%- set ns =
    namespace(total=0.0) -%} {%- for v in values -%} {%- if v is not none and v
    is number -%} {%- set ns.total = ns.total + v -%} {%- endif -%} {%- endfor
    -%} {{ ns.total }} {%- else -%} 0.0 {%- endif -%} {%- endmacro %}

    <header class="flex flex-col gap-4">
      <h2 class="text-2xl font-semibold text-purple-700">
        {{ safe_val(report_meta.report_title) }}
      </h2>
      <div class="flex justify-between items-center gap-8">
        <h1 class="text-3xl font-bold max-w-md">
          {{ safe_val(report_meta.company_name) }}
        </h1>
        <div
          class="bg-gray-100 px-10 py-2 shadow-md ring-2 ring-purple-300 rounded"
        >
          <span class="text-xl font-semibold text-purple-500">
            {{ safe_val(report_meta.rating, '') }}
          </span>
        </div>
      </div>
      <div class="flex justify-between items-center text-sm text-gray-600">
        <span>Sector: {{ safe_val(report_meta.sector) }}</span>
        <span>{{ safe_val(report_meta.report_date) }}</span>
      </div>
      <hr class="border-2 border-purple-400 -mx-2" />
    </header>

    <main class="grid grid-cols-[42%_58%]">
      <aside>
        <table class="w-full text-sm border border-purple-400">
          <thead class="bg-purple-500">
            <th class="px-2 text-white text-xs font-medium text-left">
              Company Data
            </th>
            <th></th>
          </thead>
          <tbody>
            <tr>
              <td class="px-2 text-xs">Market Cap (Rs. cr)</td>
              <td class="px-2 text-xs">
                {{ safe_val(company_snapshot.market_cap_cr) }}
              </td>
            </tr>
            <tr class="bg-gray-100">
              <td class="px-2 text-xs">52 Week High — Low (Rs.)</td>
              <td class="px-2 text-xs">
                {% set pr = company_snapshot.price_range_52w_rs %} {% if pr and
                (pr[0] is not none or pr[1] is not none) %} {{ safe_val(pr[0])
                }} - {{ safe_val(pr[1]) }} {% else %} - {% endif %}
              </td>
            </tr>
            <tr>
              <td class="px-2 text-xs">Enterprise Value (Rs. cr)</td>
              <td class="px-2 text-xs">
                {{ safe_val(company_snapshot.enterprise_value_cr) }}
              </td>
            </tr>
            <tr class="bg-gray-100">
              <td class="px-2 text-xs">Outstanding Shares (cr)</td>
              <td class="px-2 text-xs">
                {{ safe_val(company_snapshot.outstanding_shares_cr) }}
              </td>
            </tr>
            <tr>
              <td class="px-2 text-xs">Free Float (%)</td>
              <td class="px-2 text-xs">
                {{ safe_val(company_snapshot.free_float_pct) }}
              </td>
            </tr>
            <tr class="bg-gray-100">
              <td class="px-2 text-xs">Dividend Yield (%)</td>
              <td class="px-2 text-xs">
                {{ safe_val(company_snapshot.dividend_yield_pct) }}
              </td>
            </tr>
            <tr>
              <td class="px-2 text-xs">6m average volume (cr)</td>
              <td class="px-2 text-xs">
                {{ safe_val(company_snapshot.avg_volume_cr) }}
              </td>
            </tr>
            <tr class="bg-gray-100">
              <td class="px-2 text-xs">Beta</td>
              <td class="px-2 text-xs">
                {{ safe_val(company_snapshot.beta) }}
              </td>
            </tr>
            <tr>
              <td class="px-2 text-xs">Face value (Rs.)</td>
              <td class="px-2 text-xs">
                {{ safe_val(company_snapshot.face_value_rs) }}
              </td>
            </tr>
          </tbody>
        </table>

        <table class="w-full text-sm border border-purple-400">
          <thead class="bg-purple-500">
            <tr>
              <th class="px-2 py-1 text-white text-xs font-medium text-left">
                Shareholding (%)
              </th>
              {% for period in shareholding_pattern.periods or [] %}
              <th class="px-2 py-1 text-white text-xs font-medium text-center">
                {{ period }}
              </th>
              {% endfor %}
            </tr>
          </thead>

          {% set sp = shareholding_pattern.data or {} %} {% set promoters =
          sp.promoters_pct if (sp.promoters_pct is sequence and sp.promoters_pct
          is not string) else [] %} {% set fiis = sp.fiis_pct if (sp.fiis_pct is
          sequence and sp.fiis_pct is not string) else [] %} {% set mfs =
          sp.mfs_pct if (sp.mfs_pct is sequence and sp.mfs_pct is not string)
          else [] %} {% set public = sp.public_pct if (sp.public_pct is sequence
          and sp.public_pct is not string) else [] %} {% set others =
          sp.others_pct if (sp.others_pct is sequence and sp.others_pct is not
          string) else [] %} {% set data_map = { "Promoters": promoters,
          "FII's": fiis, "MFs/Institutions": mfs, "Public": public, "Others":
          others } %}

          <tbody>
            {% for category, values in data_map.items() %}
            <tr class="{% if loop.index is even %}bg-gray-50{% endif %}">
              <td class="px-2 text-xs">{{ category }}</td>
              {% set num_cols = shareholding_pattern.periods|length if
              shareholding_pattern.periods else 0 %} {% if values is sequence
              and values is not string %} {% for val in values %}
              <td class="px-2 text-xs text-center">{{ safe_val(val) }}</td>
              {% endfor %} {% else %} {% for i in range(num_cols) %}
              <td class="px-2 text-xs text-center">-</td>
              {% endfor %} {% endif %}
            </tr>
            {% endfor %}

            <!-- ---------- Totals Row ---------- -->
            <tr class="bg-gray-50 font-medium">
              <td class="px-2 text-xs">Total</td>
              {% set ncols = shareholding_pattern.periods|length if
              shareholding_pattern.periods else 0 %} {% for i in range(ncols) %}
              {% set vals = [ promoters[i] if promoters|length > i else None,
              fiis[i] if fiis|length > i else None, mfs[i] if mfs|length > i
              else None, public[i] if public|length > i else None, others[i] if
              others|length > i else None ] %} {% set total = safe_sum(vals) |
              float %}
              <td class="px-2 text-xs text-center">
                {{ '-' if total == 0 else (total | round(1)) }}
              </td>
              {% endfor %}
            </tr>
          </tbody>
        </table>

        <table class="w-full text-sm border border-purple-400">
          <thead class="bg-purple-500">
            <tr>
              <th class="px-2 py-1 text-white text-xs font-medium text-left">
                Y.E March (cr)
              </th>
              {% for col in financial_highlights.annual.columns %}
              <th class="px-2 py-1 text-white text-xs font-medium text-center">
                {{ col }}
              </th>
              {% endfor %}
            </tr>
          </thead>
          <tbody>
            {% for row in financial_highlights.annual.rows %}
            <tr class="{% if loop.index is even %}bg-gray-50{% endif %}">
              <td class="px-2 text-xs">{{ row.metric }}</td>
              {% for val in row['values'] or
              [None]*financial_highlights.annual.columns|length %}
              <td class="px-2 text-xs text-center">{{ safe_val(val) }}</td>
              {% endfor %}
            </tr>
            {% endfor %} {% for metric in
            outlook_and_valuation.valuation_table.metrics %}
            <tr
              class="{% if (loop.index + financial_highlights.annual.rows|length) is even %}bg-gray-50{% endif %}"
            >
              <td class="px-2 text-xs">{{ metric }}</td>
              {% for col in financial_highlights.annual.columns %} {% set
              val_list = outlook_and_valuation.valuation_table['values'][col] %}
              {% set val = val_list[loop.index0] if val_list|length >
              loop.index0 else None %}
              <td class="px-2 text-xs text-center">{{ safe_val(val) }}</td>
              {% endfor %}
            </tr>
            {% endfor %}
          </tbody>
        </table>

        <table class="w-full text-sm border border-purple-400">
          <thead class="bg-purple-500">
            <tr>
              <th class="px-2 py-1 text-white text-xs font-medium text-left">
                Price Performance (%)
              </th>
              <th class="px-2 py-1 text-white text-xs font-medium text-center">
                3M
              </th>
              <th class="px-2 py-1 text-white text-xs font-medium text-center">
                6M
              </th>
              <th class="px-2 py-1 text-white text-xs font-medium text-center">
                1Y
              </th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td class="px-2 text-xs">Absolute Return</td>
              {% for key in ['3M','6M','1Y'] %}
              <td class="px-2 text-xs text-center">
                {{ safe_val(price_performance.absolute_return_pct[key], '%') }}
              </td>
              {% endfor %}
            </tr>
            <tr class="bg-gray-50">
              <td class="px-2 text-xs">Sensex Return</td>
              {% for key in ['3M','6M','1Y'] %}
              <td class="px-2 text-xs text-center">
                {{ safe_val(price_performance.sensex_return_pct[key], '%') }}
              </td>
              {% endfor %}
            </tr>
          </tbody>
        </table>
      </aside>

      <section class="flex flex-col gap-4 pl-2">
        <div class="flex flex-col space-y-1">
          <h3 class="text-lg font-semibold text-purple-500 leading-none">
            {{ summary.tagline }}
          </h3>
          <div class="p-2 bg-gray-100 flex flex-col gap-2">
            <p class="text-xs leading-none">{{ summary.description }}</p>
            <ul class="list-disc list-inside space-y-0.5 text-xs text-gray-700">
              {% for point in summary.summary_bullets %}
              <li>{{ point }}</li>
              {% endfor %}
            </ul>
          </div>
        </div>

        <div class="table-wrapper">
          <div class="flex flex-col space-y-1">
            <h3 class="text-lg font-semibold text-purple-500 leading-none">
              Quarterly Financial Highlights
            </h3>
            <table class="w-full text-xs border border-purple-400">
              <thead class="bg-purple-500">
                <tr>
                  <th
                    class="px-2 py-1 text-white text-xs font-medium text-left"
                  >
                    Metric
                  </th>
                  {% for col in financial_highlights.quarterly.columns %}
                  <th
                    class="px-2 py-1 text-white text-xs font-medium text-center"
                  >
                    {{ col }}
                  </th>
                  {% endfor %}
                </tr>
              </thead>
              <tbody>
                {% for row in financial_highlights.quarterly.rows %}
                <tr class="{% if loop.index is even %}bg-gray-50{% endif %}">
                  <td class="px-2 text-xs">{{ row.metric }}</td>
                  {% for val in row['values'] or
                  [None]*financial_highlights.quarterly.columns|length %}
                  <td class="px-2 text-xs text-center">{{ safe_val(val) }}</td>
                  {% endfor %}
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>

        <div class="flex flex-col space-y-1">
          <h3 class="text-lg font-semibold text-purple-500 leading-none">
            Outlook & Valuation
          </h3>
          <div class="p-2 bg-gray-100 flex flex-col gap-2">
            <p class="text-xs leading-none">
              {{ outlook_and_valuation.summary }}
            </p>
            <ul class="list-disc list-inside space-y-0.5 text-xs text-gray-700">
              {% for point in outlook_and_valuation.analysis %}
              <li>{{ point }}</li>
              {% endfor %}
            </ul>
          </div>
        </div>
      </section>
    </main>

    <section class="flex flex-col space-y-1">
      <h3 class="text-lg font-semibold text-purple-500 leading-none">
        Key highlights
      </h3>
      <div class="p-2 bg-gray-100 flex flex-col gap-2">
        <ul class="list-disc list-inside space-y-0.5 text-xs text-gray-700">
          {% for highlight in key_highlights %}
          <li>{{ highlight }}</li>
          {% endfor %}
        </ul>
      </div>
    </section>

    <section class="flex flex-col space-y-1">
      <h3 class="text-lg font-semibold text-purple-500 leading-none">
        Quarterly Financial Performance Charts
      </h3>
      <div class="charts-grid">
        <div class="chart-box">
          <h4 class="text-xs font-semibold text-gray-700 mb-1">
            Revenue Trend (₹ Cr)
          </h4>
          <canvas id="revenueChart"></canvas>
        </div>
        <div class="chart-box">
          <h4 class="text-xs font-semibold text-gray-700 mb-1">
            EBITDA Trend (₹ Cr)
          </h4>
          <canvas id="ebitdaChart"></canvas>
        </div>
        <div class="chart-box">
          <h4 class="text-xs font-semibold text-gray-700 mb-1">
            PAT Trend (₹ Cr)
          </h4>
          <canvas id="patChart"></canvas>
        </div>
        <div class="chart-box">
          <h4 class="text-xs font-semibold text-gray-700 mb-1">
            EBITDA Margin (%)
          </h4>
          <canvas id="marginChart"></canvas>
        </div>
      </div>
    </section>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
    <script id="report-json" type="application/json">
      {{ report_data | default({}) | tojson }}
    </script>
    <script>
      const data = JSON.parse(
        document.getElementById("report-json").textContent
      );
      const q = data.financial_highlights?.quarterly;
      if (!q) console.error("Quarterly data missing");
      Chart.defaults.animation = false;
      Chart.defaults.font.family = "Fira Sans, sans-serif";
      const absCols = q.columns.filter((c) => !c.includes("%"));
      const absIdxs = absCols.map((c) => q.columns.indexOf(c));
      const qoqIdxs = q.columns
        .map((c, i) => (c.includes("QoQ%") ? i : -1))
        .filter((i) => i >= 0);
      const getValues = (m) => {
        const r = q.rows.find((r) => r.metric === m);
        return absIdxs.map((i) =>
          r?.values?.[i] == null
            ? null
            : +String(r?.values?.[i]).replace(/,/g, "")
        );
      };
      const getGrowthValues = (m) => {
        const r = q.rows.find((r) => r.metric === m);
        if (!r?.values) return [];
        const direct = qoqIdxs.map((i) =>
          r.values[i] == null ? null : +String(r.values[i]).replace(/,/g, "")
        );
        if (direct.every((v) => v == null)) {
          const abs = getValues(m);
          return abs.map((v, i) =>
            i === 0 || v == null || abs[i - 1] == null
              ? null
              : ((v - abs[i - 1]) / abs[i - 1]) * 100
          );
        }
        return direct;
      };
      const dualLabels = {
        id: "dualLabels",
        afterDraw(c) {
          const ctx = c.ctx,
            bars = c.getDatasetMeta(0).data,
            m = c.config._metric,
            g = getGrowthValues(m),
            v = c.data.datasets[0].data;
          if (!bars || !v?.length) return;
          ctx.save();
          ctx.textAlign = "center";
          bars.forEach((b, i) => {
            const val = v[i],
              gr = g[i],
              mid = b.y + (c.chartArea.bottom - b.y) / 2;
            if (val != null && !isNaN(val)) {
              ctx.fillStyle = "#fff";
              ctx.font = "600 10px Fira Sans";
              ctx.fillText(val.toLocaleString(), b.x, mid);
            }
            if (gr != null && !isNaN(gr)) {
              const pos = gr >= 0;
              ctx.fillStyle = pos ? "#16a34a" : "#dc2626";
              ctx.font = "bold 10px Fira Sans";
              ctx.fillText(
                `${pos ? "▲" : "▼"} ${Math.abs(gr).toFixed(1)}%`,
                b.x,
                b.y - 8
              );
            }
          });
          ctx.restore();
        },
      };
      const makeBarChart = (id, m, c = "#3b82f6") => {
        const el = document.getElementById(id);
        if (!el) return;
        const v = getValues(m);
        const chart = new Chart(el, {
          type: "bar",
          data: {
            labels: absCols,
            datasets: [
              {
                label: m,
                data: v,
                backgroundColor: c,
                borderRadius: 4,
                barThickness: 28,
              },
            ],
          },
          options: {
            plugins: {
              legend: { display: false },
              tooltip: { enabled: false },
            },
            scales: {
              y: { beginAtZero: true, grid: { color: "#f3f4f6" } },
              x: { grid: { display: false } },
            },
          },
          plugins: [dualLabels],
        });
        chart.config._metric = m;
        chart.update();
      };
      makeBarChart("revenueChart", "Sales");
      makeBarChart("ebitdaChart", "EBITDA");
      makeBarChart("patChart", "PAT");
      makeBarChart("marginChart", "Margin (%)");
      window.renderReady = (async () => {
        await new Promise((r) => setTimeout(r, 300));
        document.body.classList.add("ready");
      })();
    </script>
  </body>
</html>
